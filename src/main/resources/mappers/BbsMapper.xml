<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    게시판(BBS) 관련 SQL 매핑 정의
-->
<mapper namespace="com.seanet.demo.mappers.BbsMapper">

    <!-- 게시글 저장 -->
    <insert id="save" parameterType="com.seanet.demo.domain.BbsVO">
        INSERT INTO TBL_BBS (
        PST_TTL,
        PST_CN,
        PBLR_NM,
        USER_ID,
        REG_DT,
        DEL_YN
        ) VALUES (
        #{pstTtl},
        #{pstCn},
        #{pblrNm},
        #{userId},
        GETDATE(),
        'N'
        )
    </insert>

    <!-- 전체 게시글 목록 조회(페이징 없음) -->
    <select id="findAll" parameterType="long" resultType="com.seanet.demo.domain.BbsVO">
        SELECT
            PST_SN AS pstSn,
            PST_TTL AS pstTtl,
            PST_CN AS pstCn,
            PBLR_NM AS pblrNm,
            USER_ID AS userId,
            REG_DT AS regDt
        FROM TBL_BBS
        WHERE DEL_YN = 'N'
        ORDER BY PST_SN DESC
    </select>

    <!-- 검색 조건과 페이징을 적용한 게시글 목록 조회 -->
    <select id="searchPostsWithPaging" parameterType="com.seanet.demo.domain.BbsPageDTO"
            resultType="com.seanet.demo.domain.BbsVO">
        SELECT
            PST_SN AS pstSn,
            PST_TTL AS pstTtl,
            PST_CN AS pstCn,
            PBLR_NM AS pblrNm,
            USER_ID AS userId,
            REG_DT AS regDt,
            MDFCN_DT AS mdfcnDt
        FROM TBL_BBS
        WHERE DEL_YN = 'N'
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND PST_TTL LIKE '%' + #{searchKeyword} + '%'
                </when>
                <when test="searchType == 'titleContent'">
                    AND (PST_TTL LIKE '%' + #{searchKeyword} + '%'
                    OR PST_CN LIKE '%' + #{searchKeyword} + '%')
                </when>
                <when test="searchType == 'writer'">
                    AND PBLR_NM LIKE '%' + #{searchKeyword} + '%'
                </when>
                <otherwise>
                    <!-- searchType이 없거나 잘못된 값이면 제목에서 검색 -->
                    AND PST_TTL LIKE '%' + #{searchKeyword} + '%'
                </otherwise>
            </choose>
        </if>
        ORDER BY PST_SN DESC
        OFFSET #{offset} ROWS
        FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 검색 결과 총 개수 -->
    <select id="countSearchPosts" parameterType="com.seanet.demo.domain.BbsPageDTO"
            resultType="long">
        SELECT COUNT(*)
        FROM TBL_BBS
        WHERE DEL_YN = 'N'
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND PST_TTL LIKE '%' + #{searchKeyword} + '%'
                </when>
                <when test="searchType == 'titleContent'">
                    AND (PST_TTL LIKE '%' + #{searchKeyword} + '%'
                    OR PST_CN LIKE '%' + #{searchKeyword} + '%')
                </when>
                <when test="searchType == 'writer'">
                    AND PBLR_NM LIKE '%' + #{searchKeyword} + '%'
                </when>
                <otherwise>
                    <!-- searchType이 없거나 잘못된 값이면 제목에서 검색 -->
                    AND PST_TTL LIKE '%' + #{searchKeyword} + '%'
                </otherwise>
            </choose>
        </if>
    </select>

    <!-- 게시글 일련번호로 특정 게시글 상세 정보 조회 -->
    <select id="findBySn" parameterType="long" resultType="com.seanet.demo.domain.BbsVO">
        SELECT
            PST_SN AS pstSn,
            PST_TTL AS pstTtl,
            PST_CN AS pstCn,
            PBLR_NM AS pblrNm,
            USER_ID AS userId,
            REG_DT AS regDt
        FROM
            TBL_BBS
        WHERE
            PST_SN = #{pstSn}
        AND DEL_YN = 'N'
    </select>

    <!-- 게시글 수정 -->
    <update id="update" parameterType="com.seanet.demo.domain.BbsVO">
        UPDATE TBL_BBS
        SET
            PST_TTL = #{pstTtl},
            PST_CN = #{pstCn},
            MDFCN_DT = GETDATE()
        WHERE PST_SN = #{pstSn}
    </update>

    <!-- 게시글 삭제 (Soft Delete) -->
    <delete id="deleteBySn" parameterType="long">
        UPDATE TBL_BBS
        SET
            MDFCN_DT = GETDATE(),
            DEL_YN = 'Y'
        WHERE PST_SN = #{pstSn}
    </delete>

</mapper>